<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CivE265 Fall2025 - Viewer</title>

  <style>
    body { margin:0; overflow:hidden; background:#ffffff; font-family: Arial, sans-serif; }
    #stl_cont { position:absolute; inset:0; width:100%; height:100%; }

    .topbar{
      position:absolute; top:14px; left:0; right:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:1000;
    }
    .title-pill{
      pointer-events:auto;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 10px 18px;
      font-weight: 900;
      font-size: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      max-width: min(860px, 92vw);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
    }

    .back-btn{
      position:absolute; top:18px; left:18px;
      padding:10px 18px; background:#333; color:#fff;
      text-decoration:none; border-radius:10px; z-index:1001;
      font-weight:900;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    }

    /* ✅ right-top download dyn */
    .id-pill{
      position:absolute; top:18px; right:18px;
      padding:10px 16px; background:#333; color:#fff;
      border-radius:10px; z-index:1001; font-weight:900;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      opacity: 0.92;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .id-pill:hover{ opacity: 1; }

    #debugLog { display:none !important; }
  </style>

  <script src="js/stl_viewer.min.js"></script>
</head>

<body>
  <a href="index.html" class="back-btn">← Back</a>

  <div class="topbar">
    <div class="title-pill" id="titlePill">Loading title...</div>
  </div>

  <div class="id-pill" id="idPill">Download .dyn ⬇</div>
  <div id="stl_cont"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const modelId = params.get("model");
    if (!modelId) {
      alert("Error: missing parameter ?model=xxxxxxx");
      throw new Error("missing model");
    }

    const titlePill = document.getElementById("titlePill");
    const idPill = document.getElementById("idPill");

    function safePathId(id){
      return encodeURIComponent(id);
    }

    async function loadText(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return (await res.text()).trim();
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    // ✅ load title
    let currentTitle = modelId;
    (async () => {
      try{
        const t = await loadText(`titles/${safePathId(modelId)}_title.txt`);
        currentTitle = t || modelId;
        titlePill.textContent = currentTitle;
        document.title = `${currentTitle} - CivE265 Viewer`;
        titlePill.title = "Click to open description";
      }catch(e){
        currentTitle = modelId;
        titlePill.textContent = modelId;
        document.title = `ID: ${modelId} - CivE265 Viewer`;
        titlePill.title = "Click to open description";
      }
    })();

    // ✅ click title -> open description window
    titlePill.addEventListener("click", async () => {
      let desc = "";
      try{
        desc = await loadText(`descriptions/${safePathId(modelId)}_description.txt`);
        if (!desc) desc = "(No description)";
      }catch(e){
        desc = "(No description)";
      }

      const w = window.open("", "_blank", "width=760,height=620");
      if (!w) return;
      w.opener = null;

      w.document.open();
      w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>${escapeHtml(currentTitle)}</title>
          <style>
            body{ font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
            .wrap{ max-width: 920px; margin: 0 auto; }
            h1{ font-size: 18px; margin: 0 0 8px 0; }
            .id{ opacity:0.72; font-weight:900; margin-bottom: 14px; }
            pre{
              white-space: pre-wrap;
              word-break: break-word;
              background:#fff;
              border:1px solid rgba(0,0,0,0.08);
              border-radius: 12px;
              padding: 14px;
              line-height: 1.45;
              font-size: 13px;
            }
          </style>
        </head>
        <body>
          <div class="wrap">
            <h1>${escapeHtml(currentTitle)}</h1>
            <div class="id">ID: ${escapeHtml(modelId)}</div>
            <pre>${escapeHtml(desc)}</pre>
          </div>
        </body>
        </html>
      `);
      w.document.close();
    });

    // ✅ 右上角：下载 dyn/<id>.dyn（本地仓库文件）
    idPill.textContent = `Download ${modelId}.dyn ⬇`;
    idPill.title = "Click to download the Dynamo (.dyn) file";

    idPill.addEventListener("click", async () => {
      try{
        const dynUrl = `dyn/${safePathId(modelId)}.dyn`;  // ✅ 你的文件夹：dyn/id.dyn
        const res = await fetch(dynUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to fetch DYN: ${res.status} ${res.statusText}`);

        const buf = await res.arrayBuffer();
        const blobUrl = URL.createObjectURL(new Blob([buf], { type: "application/octet-stream" }));

        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = `${modelId}.dyn`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);
      }catch(err){
        console.error(err);
        alert("DYN download failed. Check if dyn/<id>.dyn exists.");
      }
    });

    // ✅ STL viewer still uses your GitHub media rule (models/<id>.stl)
    const stlUrl =
      `https://media.githubusercontent.com/media/KangruiRen0102/cive265-fall2025-gallery/main/models/${modelId}.stl`;

    (async () => {
      const res = await fetch(stlUrl, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch STL: ${res.status} ${res.statusText}`);
      const buf = await res.arrayBuffer();
      const blobUrl = URL.createObjectURL(new Blob([buf], { type: "application/octet-stream" }));

      const MODEL_COLOR = "#b8b8b8";
      const BG_COLOR    = "#ffffff";

      const viewer = new StlViewer(document.getElementById("stl_cont"), {
        load_three_files: "js/",
        auto_resize: true,
        center_models: true,
        bgcolor: BG_COLOR,
        show_status: false,
        allow_drag_and_drop: false,
        models: [{
          id: 0,
          filename: blobUrl,
          color: MODEL_COLOR,
        }],
        all_loaded_callback: () => {
          try { viewer.set_auto_zoom(); } catch(e) {}
          try { if (typeof viewer.camera_zoom === "function") viewer.camera_zoom(0.88); } catch(e) {}
          try { if (typeof viewer.set_zoom === "function") viewer.set_zoom(0.88); } catch(e) {}
          try { if (viewer.camera && viewer.camera.position) viewer.camera.position.multiplyScalar(1.12); } catch(e) {}
        }
      });

      window.addEventListener("beforeunload", () => URL.revokeObjectURL(blobUrl));
    })().catch(err => {
      console.error(err);
      alert("Model load failed. Open DevTools Console to see the error.");
    });
  </script>
</body>
</html>
